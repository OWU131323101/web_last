<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>スマホコントローラー</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- Socket.IO ライブラリ -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Socket.ioの初期化
            const socket = io();

            // デバイスIDの生成・取得
            let devid = sessionStorage.getItem('clientId');
            if (!devid) {
                devid = Math.random().toString(36).substring(2, 15);
                sessionStorage.setItem('clientId', devid);
            }

            // センサー用変数
            let interval = 50; // 送信間隔 (ms)
            let alpha = 0, beta = 0, gamma = 0;
            let z = 0;
            let isSensorRunning = false;

            // UI要素の取得 (CSSクラス/IDに合わせる)
            const connectBtn = document.getElementById("connect-btn");
            const chatLog = document.getElementById("mobile-chat-log");
            const sendBtn = document.getElementById('mobile-send-btn'); // CSSではこのIDは指定ないがHTML構造上必要
            const inputField = document.getElementById('mobile-input');

            // 1. 接続ボタンの動作
            if (connectBtn) {
                connectBtn.addEventListener("click", () => {
                    request_permission();

                    if (!isSensorRunning) {
                        isSensorRunning = true;
                        connectBtn.textContent = "送信中...";
                        connectBtn.style.opacity = "0.7";

                        // センサーデータ送信ループ開始
                        setInterval(() => {
                            socket.emit("sensor", {
                                id: devid,
                                a: alpha, b: beta, g: gamma, z: z
                            });
                        }, interval);
                    }
                });
            }

            // 2. センサーイベントハンドラ
            window.ondevicemotion = (event) => {
                if (event.accelerationIncludingGravity && event.accelerationIncludingGravity.z) {
                    z = event.accelerationIncludingGravity.z.toFixed(2);
                }
            };

            window.ondeviceorientation = (event) => {
                if (event.alpha) alpha = event.alpha.toFixed(2);
                if (event.beta) beta = event.beta.toFixed(2);
                if (event.gamma) gamma = event.gamma.toFixed(2);
            };

            // 許可リクエスト (iOS用)
            function request_permission() {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === "function") {
                    DeviceMotionEvent.requestPermission().catch(console.error);
                }
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === "function") {
                    DeviceOrientationEvent.requestPermission().catch(console.error);
                }
            }

            // 3. チャットロジック
            function addMessage(text, role) {
                const div = document.createElement('div');
                div.className = `message ${role}`;
                div.textContent = text;
                chatLog.appendChild(div);
                chatLog.scrollTop = chatLog.scrollHeight;
            }

            if (sendBtn && inputField) {
                sendBtn.addEventListener('click', () => {
                    const msg = inputField.value;
                    if (msg) {
                        socket.emit("chat_message", { id: devid, text: msg });
                        inputField.value = '';
                    }
                });
            }

            // 4. チャット受信
            socket.on('chat_broadcast', (data) => {
                // 自分のメッセージかどうかの簡易判定 (IDチェックがあればより正確)
                // ここでは role が user か bot かで表示分け
                addMessage(data.text, data.role);
            });
        });
    </script>
</head>

<body>
    <div class="mobile-container">
        <div class="mobile-header">
            宇宙ステーションと通信してみよう
        </div>

        <div class="connect-section">
            <button id="connect-btn" class="connect-btn">接続してセンサー開始</button>
        </div>

        <div class="instruction-text">
            スマホを動かして宇宙ステーションを探してみましょう
        </div>

        <!-- チャットログエリア (旧タッチパッドエリアを再利用) -->
        <div class="touchpad-area" id="mobile-chat-log"
            style="overflow-y: auto; display: flex; flex-direction: column; padding: 10px;">
            <div class="message system">通信接続待機中...</div>
        </div>

        <div class="mobile-footer">
            <div class="mobile-input-group">
                <input type="text" id="mobile-input" placeholder="メッセージを入力">
                <button id="mobile-send-btn">送信</button>
            </div>
        </div>
    </div>
</body>

</html>