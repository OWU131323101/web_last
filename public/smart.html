<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Controller</title>
    <link rel="stylesheet" href="css/style.css">

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let devid = sessionStorage.getItem('clientId');
            if (!devid) {
                devid = Math.random().toString(36).substring(2, 15);
                sessionStorage.setItem('clientId', devid);
            }

            let decPlaces = 2;
            let interval = 50; // 20 fps
            let alpha = 0, beta = 0, gamma = 0;
            let z = 0;

            const socket = io();

            // Setup UI
            const connectBtn = document.getElementById("connect-btn");
            const chatLog = document.getElementById("mobile-chat-log");

            // Connect Button Logic
            connectBtn.addEventListener("click", () => {
                connectBtn.textContent = "接続済み";
                connectBtn.style.opacity = "0.5";

                // Start sensor loop
                setInterval(() => {
                    socket.emit("sensor", {
                        id: devid,
                        a: alpha, b: beta, g: gamma, z: z
                    });
                }, interval);

                request_permission();
            });

            // Sensor Event Handlers
            window.ondevicemotion = (event) => {
                if (event.accelerationIncludingGravity && event.accelerationIncludingGravity.z) {
                    z = event.accelerationIncludingGravity.z.toFixed(decPlaces);
                }
            };

            window.ondeviceorientation = (event) => {
                if (event.alpha) alpha = event.alpha.toFixed(decPlaces);
                if (event.beta) beta = event.beta.toFixed(decPlaces);
                if (event.gamma) gamma = event.gamma.toFixed(decPlaces);
            };

            function request_permission() {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === "function") {
                    DeviceMotionEvent.requestPermission().catch(console.error);
                }
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === "function") {
                    DeviceOrientationEvent.requestPermission().catch(console.error);
                }
            }

            // Chat Logic
            const sendBtn = document.getElementById('mobile-send-btn');
            const inputField = document.getElementById('mobile-input');

            function addMessage(text, role) {
                const div = document.createElement('div');
                div.className = `message ${role}`;
                // Simple icon simulation based on role for now
                if (role === 'bot') div.innerHTML = `<div class="msg-content">${text}</div>`;
                else div.textContent = text;

                chatLog.appendChild(div);
                chatLog.scrollTop = chatLog.scrollHeight;
            }

            sendBtn.addEventListener('click', () => {
                const msg = inputField.value;
                if (msg) {
                    // Optimistic UI update
                    // addMessage(msg, 'user'); (Wait for broadcast to avoid duplicate if server echoes)
                    socket.emit("chat_message", { id: devid, text: msg });
                    inputField.value = '';
                }
            });

            // Listen for broadcasts
            socket.on('chat_broadcast', (data) => {
                console.log("Received chat:", data);
                addMessage(data.text, data.role);
            });
        });
    </script>
</head>

<body>
    <div class="mobile-container">
        <div class="mobile-header">
            宇宙ステーションと通信してみよう
        </div>

        <div class="connect-section">
            <button id="connect-btn" class="connect-btn">接続する</button>
        </div>

        <div class="instruction-text">
            スマホを動かして「座標」を合わせてみましょう
        </div>

        <!-- Chat Log Area (formerly Touchpad) -->
        <div class="touchpad-area" id="mobile-chat-log"
            style="overflow-y: auto; display: flex; flex-direction: column; padding: 10px;">
            <div class="message system">通信接続待機中...</div>
        </div>

        <div class="mobile-footer">
            <div class="mobile-input-group">
                <input type="text" id="mobile-input" placeholder="メッセージを入力">
                <button id="mobile-send-btn">送信</button>
            </div>
        </div>
    </div>
</body>

</html>